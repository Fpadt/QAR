---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  eval    = TRUE,
  echo    = FALSE,
  message = FALSE,
  warning = FALSE,
  image   = TRUE,
  results = "hide")

# Cleanse memory
rm(list = ls())
gc()

# folder locations
RW   <- file.path("C:", "Users", "fpadt", "OneDrive - GrandVision", "RW")
PRJ  <- file.path(RW  , "QAR")
MOD  <- file.path(PRJ , "00_RProj")
DAT  <- file.path(PRJ , "11_PrepData")
RES  <- file.path(PRJ , "60_Results")
FIG  <- file.path(PRJ , "70_Figures")

#source('../pythia/SharedFunctions/GenericFunctions.R')
invisible(source(file.path(MOD, "00_Global", "iSynGeneral.R")))

# SAP systems to use
pECC_SYST <- "RP1"
pECC_CLNT <- "300"
pBI_SYST  <- "BP1"
pBI_CLNT  <- "300"
pLGCINDC  <- "C"

# Data Settings
pXLSX    <- "Auths" 
# pINFO    <- file.path(PRJ, "10_RawData", "INFO.xlsx") 
# note VPN is needed for this doesn't work on internal network
# pINFO    <- "//grandvision.sharepoint.com/sites/NL1-Proj-iSynergy/05_CoE/90%20BI/INFOtst.xlsx"
pWSHT    <- TRUE
newfiles <- TRUE
SID.lng  <- c("BD1100", "BA1300", "BP1300", "BTP300", "BU1300")
SID.sht  <- substr(SID.lng, 1, 3)

dtPATH <- 
  data.table(
    DESCR = c("RW", "PRJ", "MOD", "FIG", "DAT", "RES"),
    PATH  = c( RW ,  PRJ ,  MOD ,  FIG ,  DAT ,  RES )
  )

# Open Excel for storing results
if (file.exists(paste0(RES, "/", pXLSX, ".xlsx")) == TRUE) {
  invisible(file.remove(paste0(RES, "/", pXLSX, ".xlsx")))
}

if (pWSHT == TRUE) {
  fWriteToSheet(
    dtPATH, 
    RES, pXLSX, "PATHS", pAppend = FALSE )}

gvLOGO_PATH <- file.path(FIG, "GV_LOGO.png") 
if (!file.exists(gvLOGO_PATH)) {
  download.file(
    url      = "http://www.grandvision.com/img/logoGV.png",
    destfile = gvLOGO_PATH,
    mode     = 'wb')
}
knitr::include_graphics(gvLOGO_PATH)

if (newfiles == TRUE) {
  read_and_union <- function(pTableName){
    
    dtReturn <- 
      do.call(
        rbind,
        lapply(as.list(SID.lng), function(x) {
          fGetEXPTable(
            pTableName = pTableName,
            pSystID = substr(x, 1, 3),
            pClient = substr(x, 4, 6) )
        }))
    
    return(dtReturn)
  }
  
  # read data from MS Access extract
  dtUSGRP      <- read_and_union("USGRP")
  dtUSGRPT     <- read_and_union("USGRPT")
  dtUSGRP_USER <- read_and_union("USGRP_USER")
  dtUSR02      <- read_and_union("USR02")  
  dtAGR_USERS  <- read_and_union("AGR_USERS")
  dtAUTH       <- read_and_union("#BIC#AG1AAPD0200")
  
  # dtUSR02      <- fGetEXPTable(pTableName = "USR02", pSystID = "BP1", pClient = 300)
  # dtUSR21      <- fGetEXPTable(pTableName = "USR21", pSystID = "BP1", pClient = 300)  
  # dtADR6       <- fGetEXPTable(pTableName = "ADR6" , pSystID = "BP1", pClient = 300)  
  # dtAUTH       <- fGetEXPTable(pTableName = "#BIC#AG1AAPD0200"
  #                              , pSystID = "BP1", pClient = 300)  
  
  # Read data from Local Excel File, note stats need to be refreshed
  # dtCOMM       <- as.data.table(read_excel(path = pINFO, sheet = "C.OMMENT"))
  
 } 

```